<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#128C7E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ChatApp</title>
    <link rel="icon" type="image/png" href="icon-192x192.png">
  
  
    <!-- Icono App -->
    <link rel="apple-touch-icon" sizes="152x152" href="icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180x180.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512x512.png">
    <link rel="manifest" href="manifest.json">
  
    <style>
      
      .unread-bubble {
    background-color: #128C7E; /* Color del tema */
    color: white;
    border-radius: 50%;
    min-width: 22px;
    height: 22px;
    padding: 2px;
    font-size: 12px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 5px;
}
      
      /* --- Estilos para Reacciones --- */

/* El panel pop-up */
#reactionPanel {
    display: none; /* Oculto por defecto */
    position: absolute;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 100;
    transform: translate(-50%, -110%); /* Lo centra y pone arriba del clic */
    transition: all 0.1s ease-out;
}
.reaction-button {
    background: none;
    border: none;
    font-size: 22px;
    padding: 6px;
    cursor: pointer;
    border-radius: 50%;
}
.reaction-button:hover {
    background-color: #f0f0f0;
}

/* Contenedor para los emojis *debajo* del mensaje */
.reactions-container {
    display: flex;
    gap: 4px;
    margin-top: 6px;
    /* Posicionamiento para burbujas 'sent' y 'received' */
    position: absolute;
    bottom: -10px; 
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    padding: 2px 4px;
}

/* Ajuste para las burbujas enviadas (derecha) */
.message.sent .reactions-container {
    right: 12px; 
}
/* Ajuste para las burbujas recibidas (izquierda) */
.message.received .reactions-container {
    left: 12px;
}

.reaction-emoji {
    font-size: 14px;
}
      
      /* Contenedor para el input y el picker */
.input-area-container {
    position: relative; /* Clave para posicionar el picker */
    flex-shrink: 0; /* Evita que se encoja */
}

/* Botón de Emoji */
.emoji-button {
    background-color: transparent;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #555;
    padding: 0 12px 0 8px; /* Ajuste de padding */
}

/* Estilos del Picker */
emoji-picker {
    width: 100%; /* Ocupa todo el ancho */
    height: 300px; /* Altura fija para el panel */
    position: absolute;
    bottom: 100%; /* Lo pone justo encima del contenedor del input */
    left: 0;
    z-index: 10;
    --shadow: 0 5px 15px rgba(0,0,0,0.2);
    --border-radius: 8px;
}

/* Clase para mostrar/ocultar el picker */
.emoji-picker-hidden {
    display: none;
}
      
      .chat-meta .unread-dot {
    width: 12px;
    height: 12px;
    background-color: #128C7E;
    border-radius: 50%;
    margin-left: auto; /* Mueve el punto a la derecha */
    margin-top: 4px;
}

.chat-item.unread .last-message,
.chat-item.unread .chat-name {
    font-weight: bold;
    color: #111; /* Un color más oscuro para el texto no leído */
}
      
        /* --- ESTILOS GENERALES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f5f5; height: 100vh; display: flex; justify-content: center; align-items: center; }
        .app-container { width: 100%; max-width: 400px; height: 100vh; background-color: white; border-radius: 0; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }

        /* --- NUEVA PANTALLA DE LOGIN/REGISTRO --- */
        .auth-screen { display: flex; flex-direction: column; padding: 30px 20px; justify-content: center; align-items: center; height: 100%; text-align: center; }
        .auth-form { width: 100%; max-width: 300px; margin-top: 20px; }
        .auth-form input { width: 100%; margin-bottom: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        .auth-button { background-color: #128C7E; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .auth-switch-link { color: #128C7E; cursor: pointer; margin-top: 20px; display: inline-block; }
        #registerForm { display: none; }
        .error-message { color: #d93025; font-size: 14px; margin-top: 15px; min-height: 20px; }

        /* --- ENCABEZADOS --- */
        .header { background-color: #128C7E; color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .chat-header { background-color: #128C7E; color: white; padding: 12px 16px; display: flex; align-items: center; flex-shrink: 0; }
        .back-button { margin-right: 12px; cursor: pointer; font-size: 24px; }
        .user-id-display { font-size: 10px; color: #a3e9e1; margin-top: 2px; cursor: pointer; }
        .new-chat-button { background: none; border: none; color: white; font-size: 30px; cursor: pointer; line-height: 1; }

        /* --- LISTA DE CHATS --- */
        .content { flex: 1; overflow-y: auto; }
        .chat-list { list-style: none; }
        .chat-item { padding: 12px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; cursor: pointer; }
        .chat-item:hover { background-color: #f9f9f9; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background-color: #ddd; margin-right: 12px; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px; flex-shrink: 0; }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-name { font-weight: bold; margin-bottom: 4px; }
        .last-message { color: #666; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-meta { text-align: right; }
        .chat-timestamp { font-size: 12px; color: #999; }
        .delete-chat { color: #ff4d4d; background: none; border: none; cursor: pointer; padding: 5px; font-size: 16px; }

        /* --- PANTALLA DE CHAT INDIVIDUAL --- */
        .chat-screen { display: none; flex-direction: column; height: 100%; }
        .chat-header-info { display: flex; flex-direction: column; }
        .online-status { font-size: 12px; color: #d1fff8; }
        .typing-indicator { font-size: 12px; color: #d1fff8; font-style: italic; display: none; }
        .messages-container { flex: 1; overflow-y: auto; padding: 16px; background-color: #e5ddd5; }
        .message { max-width: 80%; width: fit-content; padding: 8px 12px; border-radius: 8px; margin-bottom: 25px; position: relative; line-height: 1.4; }
        .message.sent { background-color: #DCF8C6; margin-left: auto; }
        .message.received { background-color: white; margin-right: auto; }
        .message-time { display: block; font-size: 10px; color: #999; text-align: right; margin-top: 4px; }
        .message-input-container { display: flex; padding: 8px; background-color: #f0f0f0; flex-shrink: 0; }
        .message-input { flex: 1; padding: 10px 16px; border: none; border-radius: 20px; margin-right: 8px; }
        .send-button { background-color: #128C7E; color: white; border: none; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; font-size: 20px; }

        /* --- PANTALLA DE PERFIL Y NAVEGACIÓN --- */
        .profile-screen { display: none; padding: 20px; }
        .profile-form { display: flex; flex-direction: column; }
        .profile-form input { margin-bottom: 16px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        .save-button, .logout-button { background-color: #128C7E; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; }
        .logout-button { background-color: #aa3939; margin-top: 20px; }
        .bottom-nav { display: flex; background-color: #f9f9f9; border-top: 1px solid #e0e0e0; flex-shrink: 0; }
        .nav-item { flex: 1; text-align: center; padding: 16px; cursor: pointer; color: #666; }
        .nav-item.active { color: #128C7E; border-top: 2px solid #128C7E; }
    </style>
</head>
  
<body>
    <div class="app-container">
        
        <div class="auth-screen" id="authScreen">
            <div id="loginForm">
                <h2>Iniciar Sesión</h2>
                <div class="auth-form">
                    <input type="email" id="loginEmail" placeholder="Correo electrónico" required>
                    <input type="password" id="loginPassword" placeholder="Contraseña" required>
                    <button class="auth-button" id="loginButton">Ingresar</button>
                </div>
                <p class="auth-switch-link" id="showRegister">¿No tienes cuenta? Regístrate</p>
            </div>

            <div id="registerForm">
                <h2>Crear Cuenta</h2>
                <div class="auth-form">
                    <input type="text" id="registerName" placeholder="Tu nombre" required>
                    <input type="email" id="registerEmail" placeholder="Correo electrónico" required>
                    <input type="password" id="registerPassword" placeholder="Contraseña (mín. 6 caracteres)" required>
                    <button class="auth-button" id="registerButton">Registrarme</button>
                </div>
                <p class="auth-switch-link" id="showLogin">¿Ya tienes cuenta? Inicia sesión</p>
            </div>
            <div class="error-message" id="authError"></div>
        </div>

        <div id="mainContent" style="display: none; flex-direction: column; height: 100%;">
            <div class="header">
                <div>
                    <h1>ChatApp</h1>
                    <div class="user-id-display" id="currentUserId" title="Click para copiar tu ID"></div>
                </div>
                <button class="new-chat-button" id="newChatBtn" title="Iniciar nuevo chat">+</button>
            </div>

            <div class="content" id="contentArea">
                <div id="chatsScreen">
                    <ul class="chat-list" id="chatList"></ul>
                </div>
                <div class="profile-screen" id="profileScreen">
                    <h2>Mi Perfil</h2>
                    <div class="profile-form">
                        <input type="text" id="profileName" placeholder="Tu nombre">
                        <input type="text" id="profileStatus" placeholder="Tu estado">
                        <button class="save-button" id="saveProfileBtn">Guardar Cambios</button>
                        <button class="logout-button" id="logoutButton">Cerrar Sesión</button>
                    </div>
                </div>
            </div>

            <div class="bottom-nav">
                <div class="nav-item active" id="navChats">Chats</div>
                <div class="nav-item" id="navProfile">Mi Perfil</div>
            </div>
        </div>

        <div class="chat-screen" id="chatScreen">
            <div class="chat-header">
                <div class="back-button" id="backBtn">←</div>
                <div class="avatar" id="currentChatAvatar"></div>
                <div class="chat-header-info">
                    <div id="currentChatName"></div>
                    <div class="online-status" id="onlineStatus"></div>
                    <div class="typing-indicator" id="typingIndicator">escribiendo...</div>
                </div>
            </div>
            <div class="messages-container" id="messagesContainer"></div>
            
            <div class="input-area-container">
                <emoji-picker class="emoji-picker-hidden"></emoji-picker> 
                
                <div class="message-input-container">
                    <button class="emoji-button" id="emojiBtn">😀</button>
                    
                    <input type="text" class="message-input" id="messageInput" placeholder="Escribe un mensaje...">
                    <button class="send-button" id="sendBtn">→</button>
                </div>
            </div>
        </div>
    </div>
    <div id="reactionPanel">
            <button class="reaction-button" data-emoji="👍">👍</button>
            <button class="reaction-button" data-emoji="❤️">❤️</button>
            <button class="reaction-button" data-emoji="😂">😂</button>
            <button class="reaction-button" data-emoji="😮">😮</button>
            <button class="reaction-button" data-emoji="😢">😢</button>
            <button class="reaction-button" data-emoji="❌">❌</button>
        </div>
    <script type="module">
    // 1. IMPORTACIONES (Añadimos 'increment' de Firestore)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { 
        getFirestore, collection, doc, setDoc, getDoc, serverTimestamp, 
        query, where, orderBy, onSnapshot, updateDoc, deleteDoc, addDoc, 
        increment // <-- NUEVA IMPORTACIÓN (clave para el conteo)
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import 'https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js'; 

    // 2. CONFIGURACIÓN E INICIALIZACIÓN (Sin cambios)
    const firebaseConfig = {
        apiKey: "AIzaSyBE6CYhaLokdTexZLH5zPJDmi-8a7KFbB0",
        authDomain: "chatapp-7382f.firebaseapp.com",
        projectId: "chatapp-7382f",
        storageBucket: "chatapp-7382f.appspot.com",
        messagingSenderId: "27141261584",
        appId: "1:27141261584:web:ecefba4affa1d3122bfd95",
        measurementId: "G-WTQPXV8B7J"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Variables Globales y Selectores del DOM ---
    let currentUser = null;
    let currentChatId = null; 
    let unsubscribeChatListener = null;
    let unsubscribePresenceListener = null;
    let typingTimeout = null;
    
    const authScreen = document.getElementById('authScreen');
    const mainContent = document.getElementById('mainContent');
    const chatScreen = document.getElementById('chatScreen');
    const authError = document.getElementById('authError');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const chatList = document.getElementById('chatList');
    const messageInput = document.getElementById('messageInput');
    const emojiPicker = document.querySelector('emoji-picker'); 
    const emojiBtn = document.getElementById('emojiBtn');
    const reactionPanel = document.getElementById('reactionPanel'); 
    const messagesContainer = document.getElementById('messagesContainer'); 

    // --- Observador de Autenticación (Sin cambios) ---
    onAuthStateChanged(auth, user => {
        if (user) { currentUser = user; setupAppForUser(); } 
        else { currentUser = null; showAuthScreen(); }
    });

    // --- Funciones de Autenticación, Perfil, Vistas, Latido, etc. (Sin cambios) ---
    // (Todas las funciones desde registerUser hasta goBackToChats se quedan igual)
    
    async function registerUser() {
        const name = document.getElementById('registerName').value.trim();
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value.trim();
        authError.textContent = '';
        if (!name || !email || !password) { authError.textContent = 'Todos los campos son obligatorios.'; return; }
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            await setDoc(doc(db, 'users', user.uid), {
                name: name, email: email, lastSeen: serverTimestamp(), statusText: '¡Hola! Estoy usando ChatApp.'
            });
        } catch (error) { handleAuthError(error); }
    }
    async function loginUser() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        authError.textContent = '';
        if (!email || !password) { authError.textContent = 'Todos los campos son obligatorios.'; return; }
        try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { handleAuthError(error); }
    }
    function logoutUser() { 
        updateHeartbeat(false); 
        signOut(auth); 
    }
    function handleAuthError(error) {
        console.error("Error de autenticación:", error.code);
        switch (error.code) {
            case 'auth/email-already-in-use': authError.textContent = 'Este correo electrónico ya está registrado.'; break;
            case 'auth/wrong-password': authError.textContent = 'La contraseña es incorrecta.'; break;
            case 'auth/user-not-found': authError.textContent = 'No se encontró un usuario con este correo.'; break;
            case 'auth/weak-password': authError.textContent = 'La contraseña debe tener al menos 6 caracteres.'; break;
            default: authError.textContent = 'Ocurrió un error. Inténtalo de nuevo.';
        }
    }
    async function updateProfile() {
        const name = document.getElementById('profileName').value.trim();
        const status = document.getElementById('profileStatus').value.trim();
        if (name) {
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), { name, statusText: status });
                alert("Perfil actualizado.");
                showScreen('chats');
            } catch (error) { console.error("Error al actualizar perfil:", error); }
        } else { alert("El nombre no puede estar vacío."); }
    }
    function showAuthScreen() {
        mainContent.style.display = 'none';
        chatScreen.style.display = 'none';
        authScreen.style.display = 'flex';
    }
    let heartbeatInterval = null; 
    async function setupAppForUser() {
        if (heartbeatInterval) clearInterval(heartbeatInterval); 
        updateHeartbeat(); 
        heartbeatInterval = setInterval(updateHeartbeat, 30000); 
        const userDocRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        if (userDoc.exists()) {
            const userData = userDoc.data();
            document.getElementById('profileName').value = userData.name || '';
            document.getElementById('profileStatus').value = userData.statusText || '';
        }
        document.getElementById('currentUserId').textContent = `Tu ID: ${currentUser.uid}`;
        authScreen.style.display = 'none';
        chatScreen.style.display = 'none';
        mainContent.style.display = 'flex';
        loadChats();
    }
    function updateHeartbeat(isOnline = true) {
        if (!currentUser) {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            return; 
        }
        const userDocRef = doc(db, 'users', currentUser.uid);
        try {
            updateDoc(userDocRef, { lastSeen: serverTimestamp() });
        } catch (e) { console.log("No se pudo actualizar el heartbeat."); }
        if (!isOnline && heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }
    }
    function showScreen(screen) {
        document.getElementById('chatsScreen').style.display = (screen === 'chats') ? 'block' : 'none';
        document.getElementById('profileScreen').style.display = (screen === 'profile') ? 'block' : 'none';
        document.getElementById('navChats').classList.toggle('active', screen === 'chats');
        document.getElementById('navProfile').classList.toggle('active', screen === 'profile');
    }
    function goBackToChats() {
        chatScreen.style.display = 'none';
        mainContent.style.display = 'flex';
        currentChatId = null; 
        if (unsubscribeChatListener) unsubscribeChatListener();
        if (unsubscribePresenceListener) unsubscribePresenceListener();
    }
    
    // --- LÓGICA PRINCIPAL DEL CHAT (Con funciones modificadas) ---

    function loadChats() {
        // ... (esta función no cambia) ...
        const chatsRef = collection(db, 'chats');
        const q = query(chatsRef, where('participants', 'array-contains', currentUser.uid), orderBy('lastUpdated', 'desc'));
        onSnapshot(q, snapshot => {
            chatList.innerHTML = '';
            snapshot.forEach(doc => displayChatItem({ id: doc.id, ...doc.data() }));
        });
    }

    // **MODIFICADO**: Dibuja la burbuja de conteo en lugar del punto
    async function displayChatItem(chat) {
        const otherId = chat.participants.find(id => id !== currentUser.uid);
        if (!otherId) return;
        const userDoc = await getDoc(doc(db, 'users', otherId));
        if (!userDoc.exists()) return;
        const userData = userDoc.data();
        const chatItem = document.createElement('li');
        chatItem.className = 'chat-item';
        
        // **NUEVA LÓGICA DE CONTEO**
        const unreadCount = chat.unreadCount ? (chat.unreadCount[currentUser.uid] || 0) : 0;
        
        if (unreadCount > 0) {
            chatItem.classList.add('unread'); // Sigue poniendo el texto en negrita
        }

        chatItem.innerHTML = `
            <div class="avatar">${userData.name.charAt(0).toUpperCase()}</div>
            <div class="chat-info">
                <div class="chat-name">${userData.name}</div>
                <div class="last-message">${chat.lastMessage || '...'}</div>
            </div>
            <div class="chat-meta">
                <div class="chat-timestamp">${formatTimestamp(chat.lastUpdated)}</div>
                ${unreadCount > 0 ? `<div class="unread-bubble">${unreadCount}</div>` : ''} 
                <button class="delete-chat" data-chat-id="${chat.id}">🗑️</button>
            </div>
        `;
        chatList.appendChild(chatItem);
        chatItem.addEventListener('click', () => openChat(chat.id, otherId, userData.name));
    }

    // **MODIFICADO**: Inicializa 'unreadCount' en 0 para ambos usuarios
    async function startNewChat() {
        const otherUserId = prompt("Ingresa el ID del usuario para chatear:");
        if (!otherUserId || otherUserId.trim() === '' || otherUserId === currentUser.uid) return;
        try {
            const userDoc = await getDoc(doc(db, 'users', otherUserId));
            if (!userDoc.exists()) { alert("Usuario no encontrado."); return; }
            const chatId = [currentUser.uid, otherUserId].sort().join('_');
            const chatRef = doc(db, 'chats', chatId);
            const chatDoc = await getDoc(chatRef);
            if (!chatDoc.exists()) {
                await setDoc(chatRef, { 
                    participants: [currentUser.uid, otherUserId], 
                    lastUpdated: serverTimestamp(), 
                    lastMessage: '', 
                    typing: {},
                    // **CAMBIO**: de 'isUnread' a 'unreadCount'
                    unreadCount: {
                        [currentUser.uid]: 0,
                        [otherUserId]: 0
                    } 
                });
            }
            openChat(chatId, otherUserId, userDoc.data().name);
        } catch (error) { console.error("Error al iniciar chat:", error); }
    }

    // **MODIFICADO**: Reinicia el conteo a 0 al abrir el chat
    function openChat(chatId, otherUserId, otherUserName) {
        chatScreen.dataset.chatId = chatId;
        chatScreen.dataset.otherUser = otherUserId;
        currentChatId = chatId;
        mainContent.style.display = 'none';
        chatScreen.style.display = 'flex';
        document.getElementById('currentChatName').textContent = otherUserName;
        document.getElementById('currentChatAvatar').textContent = otherUserName.charAt(0).toUpperCase();
        loadMessages(chatId); 
        
        // **CAMBIO**: Pone el 'unreadCount' del usuario actual a 0
        const chatRef = doc(db, 'chats', chatId);
        updateDoc(chatRef, {
            [`unreadCount.${currentUser.uid}`]: 0
        });

        // El resto de la función (presencia, 'escribiendo') no cambia
        unsubscribePresenceListener = onSnapshot(doc(db, 'users', otherUserId), userDoc => {
            const userData = userDoc.data();
            const statusEl = document.getElementById('onlineStatus');
            if (userData && userData.lastSeen) {
                const diffMinutes = (new Date().getTime() - userData.lastSeen.toDate().getTime()) / 60000;
                if (diffMinutes < 1) { statusEl.textContent = 'En línea'; } 
                else { statusEl.textContent = `Últ. vez ${formatTimestamp(userData.lastSeen)}`; }
            } else { statusEl.textContent = 'Desconectado'; }
        });
        unsubscribeChatListener = onSnapshot(doc(db, 'chats', chatId), chatDoc => {
            const chatData = chatDoc.data();
            document.getElementById('typingIndicator').style.display = (chatData?.typing && chatData.typing[otherUserId]) ? 'block' : 'none';
        });
    }

    function deleteChat(chatId) {
        // ... (esta función no cambia) ...
        if (confirm("¿Estás seguro de que quieres eliminar este chat?")) {
            deleteDoc(doc(db, 'chats', chatId));
        }
    }

    // **MODIFICADO**: Ahora se actualiza en tiempo real para las reacciones
    function loadMessages(chatId) {
        const q = query(collection(db, 'chats', chatId, 'messages'), orderBy('timestamp', 'asc'));
        onSnapshot(q, snapshot => {
            messagesContainer.innerHTML = ''; 
            snapshot.forEach(doc => {
                displayMessage(doc.id, doc.data()); 
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
    }

    // **MODIFICADO**: Dibuja reacciones
    function displayMessage(messageId, message) {
        const el = document.createElement('div');
        const isSent = message.senderId === currentUser.uid;
        el.className = `message ${isSent ? 'sent' : 'received'}`;
        el.dataset.messageId = messageId;
        
        let reactionsHTML = '';
        if (message.reactions) {
            const uniqueEmojis = [...new Set(Object.values(message.reactions))]; 
            reactionsHTML = `
                <div class="reactions-container">
                    ${uniqueEmojis.map(emoji => `<span class="reaction-emoji">${emoji}</span>`).join('')}
                </div>
            `;
        }
        el.innerHTML = `
            ${message.text}
            <span class="message-time">${formatTime(message.timestamp)}</span>
            ${reactionsHTML}
        `;
        messagesContainer.appendChild(el);
    }

    // **MODIFICADO**: Incrementa el 'unreadCount' del otro usuario
    async function sendMessage() {
        const text = messageInput.value.trim();
        if (text === '' || !chatScreen.dataset.chatId) return;
        const chatId = chatScreen.dataset.chatId;
        const otherUserId = chatScreen.dataset.otherUser; 
        messageInput.value = '';
        setTyping(false);
        
        await addDoc(collection(db, 'chats', chatId, 'messages'), { 
            text, 
            senderId: currentUser.uid, 
            timestamp: serverTimestamp(),
            reactions: {} 
        });
        
        // **CAMBIO**: Usa 'increment' para el otro usuario
        await updateDoc(doc(db, 'chats', chatId), { 
            lastMessage: text, 
            lastUpdated: serverTimestamp(),
            [`unreadCount.${otherUserId}`]: increment(1), // <-- Magia de Firestore
            [`unreadCount.${currentUser.uid}`]: 0 // Reinicia tu propio contador
        });
    }

    // --- Funciones de Reacciones (Sin cambios) ---
    function showReactionPanel(event, messageId) {
        reactionPanel.dataset.messageId = messageId; 
        const rect = event.target.getBoundingClientRect();
        reactionPanel.style.left = `${rect.left + rect.width / 2}px`;
        reactionPanel.style.top = `${rect.top}px`; 
        reactionPanel.style.display = 'flex';
    }
    async function addReaction(emoji) {
        const messageId = reactionPanel.dataset.messageId;
        const chatId = chatScreen.dataset.chatId;
        if (!messageId || !chatId) return;
        const docRef = doc(db, 'chats', chatId, 'messages', messageId);
        if (emoji === '❌') {
            await updateDoc(docRef, {
                [`reactions.${currentUser.uid}`]: deleteField() 
            });
        } else {
            await updateDoc(docRef, {
                [`reactions.${currentUser.uid}`]: emoji 
            });
        }
        reactionPanel.style.display = 'none'; 
    }

    // --- Otras funciones (tipeo, formato de fecha, etc.) ---
    function setTyping(isTyping) {
        if (!chatScreen.dataset.chatId) return;
        const update = {};
        update[`typing.${currentUser.uid}`] = isTyping;
        updateDoc(doc(db, 'chats', chatScreen.dataset.chatId), update);
    }
    function formatTime(timestamp) {
        return (timestamp?.toDate())?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || '';
    }
    function formatTimestamp(timestamp) {
        if (!timestamp?.toDate) return '';
        const date = timestamp.toDate();
        const now = new Date();
        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        if (date >= startOfToday) return formatTime(timestamp);
        if (date >= new Date(startOfToday.setDate(startOfToday.getDate() - 1))) return 'Ayer';
        return date.toLocaleDateString();
    }

    // --- Event Listeners (completos y sin cambios) ---
    document.getElementById('registerButton').addEventListener('click', registerUser);
    document.getElementById('loginButton').addEventListener('click', loginUser);
    document.getElementById('logoutButton').addEventListener('click', logoutUser);
    document.getElementById('showRegister').addEventListener('click', () => { registerForm.style.display = 'block'; loginForm.style.display = 'none'; authError.textContent = ''; });
    document.getElementById('showLogin').addEventListener('click', () => { loginForm.style.display = 'block'; registerForm.style.display = 'none'; authError.textContent = ''; });
    document.getElementById('newChatBtn').addEventListener('click', startNewChat);
    document.getElementById('backBtn').addEventListener('click', goBackToChats);
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('navChats').addEventListener('click', () => showScreen('chats'));
    document.getElementById('navProfile').addEventListener('click', () => showScreen('profile'));
    document.getElementById('saveProfileBtn').addEventListener('click', updateProfile);
    messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });
    messageInput.addEventListener('input', () => { clearTimeout(typingTimeout); setTyping(true); typingTimeout = setTimeout(() => setTyping(false), 2000); });
    document.getElementById('currentUserId').addEventListener('click', () => navigator.clipboard.writeText(currentUser.uid).then(() => alert('ID copiado!')));
    chatList.addEventListener('click', e => {
        if (e.target.classList.contains('delete-chat')) {
            e.stopPropagation();
            deleteChat(e.target.dataset.chatId);
        }
    });
    emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation(); 
        emojiPicker.classList.toggle('emoji-picker-hidden');
    });
    emojiPicker.addEventListener('emoji-click', event => {
        messageInput.value += event.detail.emoji.unicode; 
        messageInput.focus(); 
    });
    messagesContainer.addEventListener('click', (e) => {
        const messageEl = e.target.closest('.message'); 
        if (messageEl) {
            e.stopPropagation(); 
            const messageId = messageEl.dataset.messageId;
            showReactionPanel(e, messageId);
        }
    });
    reactionPanel.addEventListener('click', (e) => {
        e.stopPropagation(); 
        const button = e.target.closest('.reaction-button');
        if (button) {
            addReaction(button.dataset.emoji);
        }
    });
    document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
            emojiPicker.classList.add('emoji-picker-hidden');
        }
        if (!reactionPanel.contains(e.target)) {
            reactionPanel.style.display = 'none';
        }
    });
</script>
  
<script>
// Registra el Service Worker
if ('serviceWorker' in navigator) {
window.addEventListener('load', () => {
navigator.serviceWorker.register('./sw.js')
.then(registration => {
console.log('Service Worker registrado con éxito:', registration);
})
.catch(err => {
console.log('Error al registrar el Service Worker:', err);
});
});
}
</script>
  
</body>
</html>
